<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TerraSense ‚Äì Module Qualit√© de l‚Äôair</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/air.css" />
  </head>
  <body>
    <div class="page">
      <header>
        <div class="navbar">
          <div class="brand" onclick="window.location.href='/'">
            <div class="brand-icon">
              <img
                src="/images-agricultures/logo.png"
                alt="Logo TerraSense"
                style="width: 32px; height: 32px; border-radius: 999px"
              />
            </div>
            <div>
              <div class="brand-text-main">TerraSense</div>
              <div class="brand-text-sub">Module Qualit√© de l‚Äôair</div>
            </div>
          </div>
          <nav class="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a href="/agriculture" class="nav-link">Agriculture</a>
            <a href="/air" class="nav-link">Air</a>
          </nav>
        </div>
      </header>

      <main>
        <h1>
          Quel est le <span>niveau de pollution</span> de l'air&nbsp;?
        </h1>
        <p class="tagline">
          Saisissez les principales mesures issues des capteurs de la station
          pour obtenir un niveau de qualit√© de l'air simple : Bas, Moyen ou
          √âlev√©.
        </p>

        <div class="layout">
          <div class="card">
            <div class="pill">üß™ Mesures issues des capteurs</div>
            <form id="air-form" class="form-grid" style="margin-top: 1.3rem">
              <div class="field">
                <label for="PT08.S1(CO)">PT08.S1(CO)</label>
                <input
                  type="number"
                  step="0.01"
                  id="PT08.S1(CO)"
                  name="PT08.S1(CO)"
                  required
                />
                <span>Capteur 1 li√© au monoxyde de carbone</span>
              </div>

              <div class="field">
                <label for="NMHC(GT)">NMHC(GT)</label>
                <input
                  type="number"
                  step="0.01"
                  id="NMHC(GT)"
                  name="NMHC(GT)"
                  required
                />
                <span>Hydrocarbures non m√©thaniques</span>
              </div>

              <div class="field">
                <label for="C6H6(GT)">C6H6(GT)</label>
                <input
                  type="number"
                  step="0.01"
                  id="C6H6(GT)"
                  name="C6H6(GT)"
                  required
                />
                <span>Benz√®ne (C6H6)</span>
              </div>

              <div class="field">
                <label for="PT08.S2(NMHC)">PT08.S2(NMHC)</label>
                <input
                  type="number"
                  step="0.01"
                  id="PT08.S2(NMHC)"
                  name="PT08.S2(NMHC)"
                  required
                />
                <span>Capteur 2 li√© aux NMHC</span>
              </div>

              <div class="field">
                <label for="NOx(GT)">NOx(GT)</label>
                <input
                  type="number"
                  step="0.01"
                  id="NOx(GT)"
                  name="NOx(GT)"
                  required
                />
                <span>Oxydes d‚Äôazote</span>
              </div>

              <div class="field">
                <label for="PT08.S3(NOx)">PT08.S3(NOx)</label>
                <input
                  type="number"
                  step="0.01"
                  id="PT08.S3(NOx)"
                  name="PT08.S3(NOx)"
                  required
                />
                <span>Capteur 3 pour NOx</span>
              </div>

              <div class="field">
                <label for="NO2(GT)">NO2(GT)</label>
                <input
                  type="number"
                  step="0.01"
                  id="NO2(GT)"
                  name="NO2(GT)"
                  required
                />
                <span>Dioxyde d‚Äôazote</span>
              </div>

              <div class="field">
                <label for="PT08.S4(NO2)">PT08.S4(NO2)</label>
                <input
                  type="number"
                  step="0.01"
                  id="PT08.S4(NO2)"
                  name="PT08.S4(NO2)"
                  required
                />
                <span>Capteur 4 pour NO2</span>
              </div>

              <div class="field">
                <label for="PT08.S5(O3)">PT08.S5(O3)</label>
                <input
                  type="number"
                  step="0.01"
                  id="PT08.S5(O3)"
                  name="PT08.S5(O3)"
                  required
                />
                <span>Capteur 5 pour O3 (ozone)</span>
              </div>

              <div class="full-width submit-row">
                <button type="submit" class="btn-primary">
                  üí® √âvaluer la qualit√© de l‚Äôair
                </button>
                <div class="hint">
                  Le mod√®le classe le niveau de pollution en Bas, Moyen ou
                  √âlev√©.
                </div>
              </div>
            </form>
          </div>

          <div class="card">
            <div class="pill">üìä R√©sultat</div>
            <div id="air-result" class="result" style="margin-top: 1rem">
              <div class="result-title">
                <div class="result-main">
                  Niveau de pollution :
                  <span id="air-level"></span>
                </div>
              </div>
              <div id="air-explanation" style="margin-top: 1rem; font-size: 1rem; line-height: 1.6; color: var(--text-muted)">
                <!-- Message interpr√©table affich√© ici -->
              </div>
              <div id="air-status" class="status" style="margin-top: 1rem">
                <div class="status-dot"></div>
                <span>
                  Niveau de pollution estim√© √† partir des capteurs.
                </span>
              </div>
            </div>
            <div
              id="air-result-placeholder"
              style="
                margin-top: 1rem;
                font-size: 0.86rem;
                color: var(--text-muted);
              "
            >
              Remplissez les mesures des capteurs puis cliquez sur
              <strong>‚Äú√âvaluer la qualit√© de l‚Äôair‚Äù</strong> pour voir ici le
              niveau global de pollution.
            </div>
          </div>
        </div>
      </main>

      <footer>
        TerraSense ‚Äì Module Qualit√© de l‚Äôair (classification Bas / Moyen /
        √âlev√©). üí®
      </footer>
    </div>

    <script>
      async function predictAir(formData) {
        const response = await fetch("/predict_air", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });

        if (!response.ok) {
          throw new Error("Erreur de pr√©diction");
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || "Erreur de pr√©diction");
        }

        return result;
      }

      const airForm = document.getElementById("air-form");
      const airResultBox = document.getElementById("air-result");
      const airResultPlaceholder =
        document.getElementById("air-result-placeholder");
      const airLevelEl = document.getElementById("air-level");
      const airExplanationEl = document.getElementById("air-explanation");
      const airStatusEl = document.getElementById("air-status");

      airForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {};
        [
          "PT08.S1(CO)",
          "NMHC(GT)",
          "C6H6(GT)",
          "PT08.S2(NMHC)",
          "NOx(GT)",
          "PT08.S3(NOx)",
          "NO2(GT)",
          "PT08.S4(NO2)",
          "PT08.S5(O3)",
        ].forEach((name) => {
          formData[name] = airForm[name].value;
        });

        airStatusEl.classList.remove("error");
        airStatusEl.innerHTML =
          '<div class="status-dot"></div><span>Calcul en cours‚Ä¶</span>';
        airResultBox.classList.add("visible");
        airResultPlaceholder.style.display = "none";

        try {
          const result = await predictAir(formData);
          airLevelEl.textContent = result.label;

          const messages = {
            0: "Air globalement bon. Les activit√©s ext√©rieures peuvent se d√©rouler normalement.",
            1: "Qualit√© de l'air moyenne. Les personnes sensibles peuvent limiter les efforts prolong√©s en ext√©rieur.",
            2: "Pollution √©lev√©e. √âvitez les efforts intenses en ext√©rieur et privil√©giez les espaces ferm√©s.",
          };

          airExplanationEl.textContent =
            messages[result.class] || result.explanation || "Niveau de pollution estim√©.";

          airStatusEl.classList.remove("error");
          airStatusEl.innerHTML =
            '<div class="status-dot"></div><span>Interpr√©tez ce niveau pour adapter vos actions (trafic, activit√©s, sensibilisation).</span>';
        } catch (err) {
          airStatusEl.classList.add("error");
          airStatusEl.innerHTML =
            '<div class="status-dot"></div><span style="color:#ef4444">Erreur : ' +
            (err.message || "erreur inconnue") +
            "</span>";
        }
      });
    </script>
  </body>
  </html>


