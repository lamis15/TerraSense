<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TerraSense - Qualite de l'eau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/water.css" />
    <script>
      (function () {
        const ok = localStorage.getItem("terrasense-auth");
        if (!ok && window.location.pathname !== "/signin") {
          window.location.replace("/signin");
        }
      })();
    </script>
  </head>
  <body>
    <div class="page-bg" aria-hidden="true">
      <video class="bg-video" autoplay muted loop playsinline poster="/static/media/water.jpg">
        <source src="/static/media/water.mp4" type="video/mp4" />
      </video>
      <div class="page-overlay"></div>
    </div>
    <div class="page">
      <header>
        <div class="navbar">
          <div class="brand">
            <div class="brand-icon">
              <img src="/images-agricultures/logo.png" alt="Logo TerraSense" />
            </div>
            <div>
              <div class="brand-text-main">TerraSense</div>
              <div class="brand-text-sub">Intelligence pour la Terre</div>
            </div>
          </div>
          <nav class="nav-links">
            <a href="/home" class="nav-link">Home</a>
            <a href="/agriculture" class="nav-link">Agriculture</a>
            <a href="/air" class="nav-link">Air</a>
            <a href="/water" class="nav-link">Water</a>
          </nav>
        </div>
      </header>

      <main>
        <section class="hero">
          <div class="hero-grid">
            <div class="hero-copy">
              <p class="eyebrow">Module water quality</p>
              <h1>
                Prediction de la qualite de l'eau
                <span>dans vos bassins.</span>
              </h1>
              <p class="tagline">
                Entrez les parametres essentiels pour estimer la qualite de l'eau
                et anticiper les actions de traitement.
              </p>
            </div>
            <div class="hero-visual beach-video" aria-hidden="true">
              <video
                class="bg-video"
                autoplay
                muted
                loop
                playsinline
                poster="/static/media/water.jpg"
              >
                <source src="/static/media/water.mp4" type="video/mp4" />
              </video>
              <div class="video-overlay"></div>
              <div class="photo-sheen"></div>
              <div class="tide tide-1"></div>
              <div class="tide tide-2"></div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="layout">
            <div class="card" id="water-guide-card">
              <div class="pill">Guide des parametres</div>
              <div style="margin-top: 0.6rem; font-size: 0.86rem; color: var(--text-muted)">
                Avant de saisir vos donnees, parcourez ce guide pour comprendre
                a quoi sert chaque information.
              </div>

              <div class="wizard-steps">
                <div
                  class="wizard-step-indicator active"
                  id="water-indicator-step-1"
                ></div>
                <div class="wizard-step-indicator" id="water-indicator-step-2"></div>
                <div class="wizard-step-indicator" id="water-indicator-step-3"></div>
              </div>
              <div class="wizard-labels">
                <span>Chimie de base</span>
                <span>Contaminants</span>
                <span>Resume</span>
              </div>

              <div class="wizard-step active" data-step="1">
                <h3 style="margin: 0 0 0.4rem; font-size: 1rem">
                  1. Parametres physico-chimiques
                </h3>
                <ul
                  style="
                    padding-left: 1.1rem;
                    margin: 0.3rem 0;
                    font-size: 0.86rem;
                    color: var(--text-muted);
                  "
                >
                  <li><strong>pH</strong> : acidite ou basicite.</li>
                  <li><strong>Hardness</strong> et <strong>Solids</strong> : mineraux dissous.</li>
                  <li><strong>Conductivity</strong> : mineralisation globale.</li>
                </ul>

                <div class="mini-illustration">
                  <img
                    class="guide-image"
                    src="/static/media/water.jpg"
                    alt="Analyse de l'eau"
                  />
                  <div class="mini-illustration-text">
                    Illustration de <strong>tests de base</strong> pour la qualite de l'eau.
                  </div>
                </div>

                <div class="wizard-actions">
                  <span class="hint">Etape 1/3 - Etat chimique general.</span>
                  <button type="button" class="btn-primary" id="water-next-step-1">
                    Suivant
                  </button>
                </div>
              </div>

              <div class="wizard-step" data-step="2">
                <h3 style="margin: 0 0 0.4rem; font-size: 1rem">
                  2. Contaminants et particules
                </h3>
                <ul
                  style="
                    padding-left: 1.1rem;
                    margin: 0.3rem 0;
                    font-size: 0.86rem;
                    color: var(--text-muted);
                  "
                >
                  <li><strong>Chloramines</strong> et <strong>Sulfate</strong> : traitement et ions.</li>
                  <li><strong>Organic carbon</strong> et <strong>Trihalomethanes</strong> : matiere organique.</li>
                  <li><strong>Turbidity</strong> : particules en suspension.</li>
                </ul>

                <div class="mini-illustration">
                  <img
                    class="guide-image"
                    src="/static/media/water.jpg"
                    alt="Pollution de l'eau"
                  />
                  <div class="mini-illustration-text">
                    Illustration des <strong>contaminants</strong> et de la turbidite.
                  </div>
                </div>

                <div class="wizard-actions">
                  <button type="button" class="btn-secondary" id="water-prev-step-2">
                    Retour
                  </button>
                  <button type="button" class="btn-primary" id="water-next-step-2">
                    Suivant
                  </button>
                </div>
              </div>

              <div class="wizard-step" data-step="3">
                <h3 style="margin: 0 0 0.4rem; font-size: 1rem">
                  3. Vue d'ensemble
                </h3>
                <div
                  style="
                    font-size: 0.86rem;
                    color: var(--text-muted);
                    margin-bottom: 0.6rem;
                  "
                >
                  Le modele combine ces parametres pour indiquer si l'eau est
                  <strong>Potable</strong> ou <strong>Non potable</strong>.
                </div>

                <div class="mini-illustration">
                  <img
                    class="guide-image"
                    src="/static/media/home-env.jpg"
                    alt="Evaluation globale de l'eau"
                  />
                  <div class="mini-illustration-text">
                    Synthese des <strong>mesures combinees</strong> avant decision.
                  </div>
                </div>

                <div class="wizard-actions">
                  <button type="button" class="btn-secondary" id="water-prev-step-3">
                    Retour
                  </button>
                  <button
                    type="button"
                    class="btn-primary"
                    id="water-show-form-button"
                  >
                    Passer a la saisie des parametres
                  </button>
                </div>
              </div>
            </div>

            <div class="card" id="water-form-card" style="margin-top: 1.8rem; display: none">
              <div class="pill">Saisie des parametres</div>
              <form id="water-form" class="form-grid" style="margin-top: 1.3rem">
                <div class="field">
                  <label for="ph">pH</label>
                  <input type="number" step="0.01" id="ph" name="ph" required />
                  <span>Acidite ou basicite de l'eau</span>
                </div>

                <div class="field">
                  <label for="hardness">Hardness</label>
                  <input
                    type="number"
                    step="0.1"
                    id="hardness"
                    name="hardness"
                    required
                  />
                  <span>Durete de l'eau (mg/L)</span>
                </div>

                <div class="field">
                  <label for="solids">Solids</label>
                  <input
                    type="number"
                    step="0.1"
                    id="solids"
                    name="solids"
                    required
                  />
                  <span>Solides dissous totaux (ppm)</span>
                </div>

                <div class="field">
                  <label for="chloramines">Chloramines</label>
                  <input
                    type="number"
                    step="0.01"
                    id="chloramines"
                    name="chloramines"
                    required
                  />
                  <span>Concentration en chloramines (mg/L)</span>
                </div>

                <div class="field">
                  <label for="sulfate">Sulfate</label>
                  <input
                    type="number"
                    step="0.1"
                    id="sulfate"
                    name="sulfate"
                    required
                  />
                  <span>Concentration en sulfate (mg/L)</span>
                </div>

                <div class="field">
                  <label for="conductivity">Conductivity</label>
                  <input
                    type="number"
                    step="0.1"
                    id="conductivity"
                    name="conductivity"
                    required
                  />
                  <span>Mineralisation totale</span>
                </div>

                <div class="field">
                  <label for="organic_carbon">Organic Carbon</label>
                  <input
                    type="number"
                    step="0.01"
                    id="organic_carbon"
                    name="organic_carbon"
                    required
                  />
                  <span>Carbone organique total (mg/L)</span>
                </div>

                <div class="field">
                  <label for="trihalomethanes">Trihalomethanes</label>
                  <input
                    type="number"
                    step="0.01"
                    id="trihalomethanes"
                    name="trihalomethanes"
                    required
                  />
                  <span>Concentration en trihalomethanes (ug/L)</span>
                </div>

                <div class="field">
                  <label for="turbidity">Turbidity</label>
                  <input
                    type="number"
                    step="0.01"
                    id="turbidity"
                    name="turbidity"
                    required
                  />
                  <span>Niveau de particules en suspension</span>
                </div>

                <div class="full-width submit-row">
                  <button type="submit" class="btn-primary">
                    Evaluer la qualite de l'eau
                  </button>
                  <div class="hint">
                    Le modele de prediction est connecte et pret a evaluer la qualite de l'eau.
                  </div>
                </div>
              </form>
            </div>

            <div class="card" id="water-result-card" style="display: none">
              <div class="pill">Resultat</div>
              <div id="water-result" class="result" style="margin-top: 1rem; display: none;">
                <div id="water-result-box" class="result-box">
                  <div id="water-icon" class="result-icon"></div>
                  <div id="water-level" class="result-label">En attente</div>
                  <div id="water-explanation" class="result-description"></div>
                </div>
              </div>
              <div
                id="water-result-placeholder"
                style="
                  margin-top: 1rem;
                  font-size: 0.86rem;
                  color: var(--text-muted);
                "
              >
                Renseignez les parametres puis cliquez sur
                <strong>Evaluer la qualite de l'eau</strong> pour afficher le
                resultat ici.
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        TerraSense - Module qualite de l'eau.
      </footer>
    </div>

    <script>
      async function predictWater(formData) {
        const response = await fetch("/predict_water", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
          const errorMsg = result.error || `Erreur HTTP ${response.status}`;
          throw new Error(errorMsg);
        }
        return result;
      }

      const waterForm = document.getElementById("water-form");
      const waterResult = document.getElementById("water-result");
      const waterResultBox = document.getElementById("water-result-box");
      const waterResultPlaceholder = document.getElementById("water-result-placeholder");
      const waterLevelEl = document.getElementById("water-level");
      const waterExplanationEl = document.getElementById("water-explanation");
      const waterIcon = document.getElementById("water-icon");
      const waterFormCard = document.getElementById("water-form-card");
      const waterResultCard = document.getElementById("water-result-card");

      const waterSteps = document.querySelectorAll("#water-guide-card .wizard-step");
      const waterIndicators = [
        document.getElementById("water-indicator-step-1"),
        document.getElementById("water-indicator-step-2"),
        document.getElementById("water-indicator-step-3"),
      ];
      let waterCurrentStep = 0;

      function showWaterStep(index) {
        waterSteps.forEach((step, i) => {
          step.classList.toggle("active", i === index);
        });
        waterIndicators.forEach((ind, i) => {
          ind.classList.toggle("active", i <= index);
        });
        waterCurrentStep = index;
      }

      document
        .getElementById("water-next-step-1")
        .addEventListener("click", () => showWaterStep(1));
      document
        .getElementById("water-next-step-2")
        .addEventListener("click", () => showWaterStep(2));
      document
        .getElementById("water-prev-step-2")
        .addEventListener("click", () => showWaterStep(0));
      document
        .getElementById("water-prev-step-3")
        .addEventListener("click", () => showWaterStep(1));

      document
        .getElementById("water-show-form-button")
        .addEventListener("click", () => {
          waterFormCard.style.display = "block";
          window.scrollTo({
            top: waterFormCard.offsetTop - 80,
            behavior: "smooth",
          });
        });

      waterForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {
          ph: parseFloat(waterForm.ph.value),
          hardness: parseFloat(waterForm.hardness.value),
          solids: parseFloat(waterForm.solids.value),
          chloramines: parseFloat(waterForm.chloramines.value),
          sulfate: parseFloat(waterForm.sulfate.value),
          conductivity: parseFloat(waterForm.conductivity.value),
          organic_carbon: parseFloat(waterForm.organic_carbon.value),
          trihalomethanes: parseFloat(waterForm.trihalomethanes.value),
          turbidity: parseFloat(waterForm.turbidity.value),
        };

        waterResultPlaceholder.style.display = "none";
        waterResultCard.style.display = "block";
        waterResult.style.display = "block";
        waterResultBox.className = "result-box result-loading";
        waterIcon.innerHTML = '<div class="loading-spinner"></div>';
        waterLevelEl.textContent = "Analyse en cours...";
        waterExplanationEl.textContent = "";

        try {
          const result = await predictWater(formData);

          waterResult.style.display = "block";
          waterResultPlaceholder.style.display = "none";

          const isPotable = result.is_potable;

          if (isPotable) {
            waterResultBox.className = "result-box result-potable";
            waterIcon.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
            waterLevelEl.textContent = result.label;
            waterExplanationEl.textContent = result.explanation || "This water is safe to drink!";
          } else {
            waterResultBox.className = "result-box result-non-potable";
            waterIcon.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>';
            waterLevelEl.textContent = result.label;
            waterExplanationEl.textContent = result.explanation || "This water is NOT safe to drink!";
          }
        } catch (err) {
          const errorMsg = err.message || "erreur inconnue";
          console.error("Erreur de prediction:", err);

          waterResult.style.display = "block";
          waterResultPlaceholder.style.display = "none";
          waterResultBox.className = "result-box result-error";
          waterIcon.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>';
          waterLevelEl.textContent = "ERREUR";
          waterExplanationEl.textContent = errorMsg;
        }
      });
    </script>
  </body>
</html>
